<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards de Estudo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        html, body { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #111827, #1e1b4b, #312e81, #1e293b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-container { perspective: 1000px; }
        .flashcard { transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .card-back { transform: rotateY(180deg); }
        .markdown-content ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; }
        .markdown-content li { margin-bottom: 4px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }

        .popover {
            transform-origin: bottom center;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
    </style>
</head>
<body class="text-slate-200">

    <div id="main-container" class="w-full max-w-7xl mx-auto h-full flex flex-col p-4 md:p-6">
        <div id="home-screen" class="w-full h-full bg-slate-900/70 backdrop-blur-xl border border-slate-700/50 rounded-3xl shadow-2xl shadow-black/30 overflow-hidden grid grid-cols-1 md:grid-cols-[minmax(250px,300px)_1fr]">
            <div class="w-full border-b md:border-r border-slate-700/50 p-4 flex flex-col bg-slate-900/50">
                <div class="space-y-3 mb-4 flex-shrink-0">
                    <a href="index.html" class="group w-full flex items-center justify-center space-x-2 text-center py-2.5 px-4 bg-slate-800/80 text-slate-300 font-semibold rounded-lg hover:bg-slate-700/80 hover:text-white transition-colors text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/></svg>
                        <span>Central de Comando</span>
                    </a>
                    <button id="add-card-button" class="group w-full flex items-center justify-center space-x-2 py-2.5 px-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-indigo-500/40 transform hover:scale-105 transition-all text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/></svg>
                        <span>Adicionar Card</span>
                    </button>
                </div>
                <div class="flex-shrink-0 border-t border-slate-700/50 pt-3">
                     <h3 class="text-lg font-bold text-indigo-400 mb-3">Opções de Estudo</h3>
                     <div class="flex items-center justify-between p-2 rounded-lg bg-slate-800/80">
                         <label for="shuffle-toggle" class="text-sm font-medium text-slate-300">Embaralhar Cards</label>
                         <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="shuffle-toggle" id="shuffle-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="shuffle-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-700 cursor-pointer"></label>
                        </div>
                     </div>
                </div>
                <div class="flex-shrink-0 border-t border-slate-700/50 pt-3 mt-4">
                    <h3 class="text-lg font-bold text-indigo-400 mb-3">Filtros</h3>
                    <input type="text" id="search-input" placeholder="Buscar no conteúdo..." class="w-full p-2 mb-3 bg-slate-800 border border-slate-700 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 placeholder-slate-500">
                </div>
                <div id="filter-controls" class="flex-grow overflow-y-auto pr-2"><p class="text-sm text-slate-500">Carregando filtros...</p></div>
                 <div class="flex-shrink-0 pt-2 border-t border-slate-700/50">
                    <button id="clear-filters-button" class="w-full text-center text-sm text-indigo-400 font-semibold hover:underline">Limpar Filtros</button>
                </div>
            </div>
            
            <div id="home-content" class="flex-grow p-6 md:p-8 overflow-y-auto">
                <h1 class="text-4xl font-extrabold text-white mb-6">Revisão Ativa</h1>
                <div id="loading" class="text-center p-8"><div class="animate-spin inline-block w-6 h-6 border-4 border-t-4 border-indigo-500 border-opacity-25 rounded-full mr-2"></div><p class="text-lg font-medium text-slate-400">Carregando flashcards...</p></div>
                <p id="folder-view-message" class="text-slate-400 mb-6 hidden">Selecione filtros ao lado para começar.</p>
                <div id="folder-view" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
            </div>
        </div>

        <div id="study-screen" class="w-full max-w-3xl mx-auto hidden"></div>
    </div>

    <div id="new-card-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden z-50"></div>
    <div id="edit-card-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden z-50"></div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden z-50"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & STATE ---
        const Config = {
            firebase: {
                apiKey: "AIzaSyAJ7fpCQPimWgcJuYiLbCZ5Rf5YUgMVZ2Q",
                authDomain: "ghus-app.firebaseapp.com",
                projectId: "ghus-app",
                storageBucket: "ghus-app.firebasestorage.app",
                messagingSenderId: "1047907929485",
                appId: "1:1047907929485:web:cba05f2850df61d201c1c4",
            },
            MASTERY_LEVELS: {
                'gray': { name: 'Padrão', cardBg: 'bg-slate-800', hex: '#64748b' },
                'red': { name: 'Revisar', cardBg: 'bg-red-900/50', hex: '#ef4444' },
                'orange': { name: 'Difícil', cardBg: 'bg-orange-900/50', hex: '#f97316' },
                'yellow': { name: 'Médio', cardBg: 'bg-yellow-900/50', hex: '#eab308' },
                'green': { name: 'Fácil', cardBg: 'bg-green-900/50', hex: '#22c55e' },
                'blue': { name: 'Dominado', cardBg: 'bg-blue-900/50', hex: '#3b82f6' }
            },
            COLOR_ORDER: ['red', 'orange', 'yellow', 'green', 'blue', 'gray'],
            VALUE_TO_COLOR_MAP: { 0: 'gray', 1: 'red', 2: 'orange', 3: 'yellow', 4: 'green', 5: 'blue' }
        };

        const State = {
            allCards: [],
            currentDeckCards: [],
            currentCardIndex: 0,
            isFlipped: false,
            authUser: null
        };

        const DOM = {};

        // --- SERVICES ---
        const FirebaseService = {
            db: null,
            init() {
                const app = initializeApp(Config.firebase);
                const auth = getAuth(app);
                this.db = getFirestore(app);
                return { auth };
            },
            connect(auth, onData) {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        State.authUser = user;
                        onSnapshot(collection(this.db, 'flashcards'), snapshot => {
                            const cards = snapshot.docs.map(doc => ({
                                ...doc.data(),
                                id: doc.id,
                                masterycolor: this.convertMastery(doc.data().masterycolor)
                            }));
                            onData(cards);
                        }, err => console.error("Firebase Error:", err));
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Sign-in failed", err));
                    }
                });
            },
            convertMastery(value) {
                return Config.VALUE_TO_COLOR_MAP[value] || (Config.MASTERY_LEVELS[value] ? value : 'gray');
            },
            updateMastery(cardId, color) {
                return updateDoc(doc(this.db, 'flashcards', cardId), { masterycolor: color });
            },
            addCard(cardData) {
                return addDoc(collection(this.db, 'flashcards'), { ...cardData, userId: State.authUser.uid, createdAt: serverTimestamp() });
            },
            updateCard(cardId, cardData) {
                return updateDoc(doc(this.db, 'flashcards', cardId), cardData);
            },
            deleteCard(cardId) {
                return deleteDoc(doc(this.db, 'flashcards', cardId));
            }
        };

        // --- UI MANAGER ---
        const UI = {
            populate() {
                Object.assign(DOM, {
                    homeScreen: document.getElementById('home-screen'),
                    studyScreen: document.getElementById('study-screen'),
                    loading: document.getElementById('loading'),
                    folderView: document.getElementById('folder-view'),
                    folderViewMessage: document.getElementById('folder-view-message'),
                    filterControls: document.getElementById('filter-controls'),
                    searchInput: document.getElementById('search-input'),
                    clearFiltersButton: document.getElementById('clear-filters-button'),
                    addCardButton: document.getElementById('add-card-button'),
                    shuffleToggle: document.getElementById('shuffle-toggle'),
                    newCardModal: document.getElementById('new-card-modal'),
                    editCardModal: document.getElementById('edit-card-modal'),
                    deleteConfirmModal: document.getElementById('delete-confirm-modal'),
                });

                const cardFormHTML = (idPrefix, title) => `<div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4 border border-slate-700"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-200">${title}</h3><button data-close-modal class="text-slate-500 hover:text-slate-200 text-2xl leading-none">&times;</button></div><form id="${idPrefix}-card-form" class="space-y-4"><div><label for="${idPrefix}-card-question" class="block text-sm font-medium text-slate-400">Frente (Pergunta)</label><textarea id="${idPrefix}-card-question" required rows="4" class="mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-md"></textarea></div><div><label for="${idPrefix}-card-answer" class="block text-sm font-medium text-slate-400">Verso (Resposta)</label><textarea id="${idPrefix}-card-answer" required rows="4" class="mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-md"></textarea></div><div class="flex space-x-4"><div class="flex-1"><label for="${idPrefix}-card-specialty" class="block text-sm font-medium text-slate-400">Especialidade</label><input type="text" id="${idPrefix}-card-specialty" required class="mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-md"></div><div class="flex-1"><label for="${idPrefix}-card-tags" class="block text-sm font-medium text-slate-400">Tags</label><input type="text" id="${idPrefix}-card-tags" class="mt-1 w-full p-2 bg-slate-700 border border-slate-600 rounded-md"></div></div><div class="pt-2"><button type="submit" class="w-full py-2 px-4 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700">${idPrefix === 'new' ? 'Adicionar' : 'Salvar'}</button></div><p id="${idPrefix}-card-message" class="text-center mt-2 text-sm hidden"></p></form></div>`;
                DOM.newCardModal.innerHTML = cardFormHTML('new', 'Criar Novo Flashcard');
                DOM.editCardModal.innerHTML = cardFormHTML('edit', 'Editar Flashcard');
                DOM.deleteConfirmModal.innerHTML = `<div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 border border-slate-700"><h3 class="text-lg font-bold text-slate-200 mb-2">Confirmar Exclusão</h3><p class="text-slate-400 mb-6">Tem certeza? Esta ação não pode ser desfeita.</p><div class="flex justify-end space-x-4"><button id="cancel-delete-button" class="py-2 px-4 bg-slate-700 text-slate-200 font-bold rounded-lg hover:bg-slate-600">Cancelar</button><button id="confirm-delete-button" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Excluir</button></div></div>`;
                
                DOM.studyScreen.innerHTML = `<div class="flex justify-between items-center w-full mb-4"><button id="back-to-home-button" class="text-sm font-semibold text-slate-400 hover:text-indigo-400">← Voltar</button><div id="study-title" class="text-center text-indigo-400 font-extrabold text-lg"></div><div class="flex items-center space-x-2 text-slate-400"><button id="edit-card-button" title="Editar Card" class="p-2 rounded-full hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zM13.75 3.5l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button><button id="delete-card-button" title="Excluir Card" class="p-2 rounded-full hover:bg-slate-700 transition-colors text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5zM4.5 5.029L5 13.5a.5.5 0 1 0 .998-.06L5 5.029a.5.5 0 1 0-.998.06zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528zM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5z"/></svg></button></div></div><div id="card-counter" class="text-center text-slate-400 font-semibold mb-4"></div><div class="card-container w-full h-96 mb-6"><div id="flashcard" class="flashcard relative w-full h-full cursor-pointer"><div id="card-front" class="card-face absolute w-full h-full flex items-center justify-center p-8 rounded-2xl shadow-xl transition-colors duration-300 bg-slate-800 border border-slate-700"><div class="markdown-content text-2xl md:text-3xl font-semibold text-center text-slate-200"></div></div><div id="card-back" class="card-face card-back absolute w-full h-full flex items-center justify-center p-8 rounded-2xl shadow-xl transition-colors duration-300 bg-indigo-600 text-white"><div class="markdown-content text-xl md:text-2xl text-center text-white"></div></div></div></div><div class="flex justify-center items-center space-x-4"><button id="prev-button" class="w-16 h-16 flex items-center justify-center bg-slate-800/80 rounded-full text-slate-400 hover:bg-slate-700/80 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/></svg></button><div id="mastery-popover-container" class="relative"><button id="mastery-popover-button" class="flex items-center justify-center space-x-2 min-w-[150px] text-center py-3 px-6 bg-slate-700/80 text-white font-semibold rounded-full hover:bg-slate-700 transition-colors"><span id="mastery-color-indicator" class="w-4 h-4 rounded-full"></span><span id="mastery-text-indicator"></span></button><div id="mastery-popover" class="popover absolute bottom-full mb-2 w-full bg-slate-800 border border-slate-700 rounded-xl p-2 space-y-1 shadow-lg hidden opacity-0 scale-95"></div></div><button id="next-button" class="w-16 h-16 flex items-center justify-center bg-slate-800/80 rounded-full text-slate-400 hover:bg-slate-700/80 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793l-2.147-2.146a.5.5 0 0 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z"/></svg></button></div>`;

                Object.assign(DOM, {
                    newCardForm: document.getElementById('new-card-form'),
                    editCardForm: document.getElementById('edit-card-form'),
                    confirmDeleteButton: document.getElementById('confirm-delete-button'),
                    cancelDeleteButton: document.getElementById('cancel-delete-button'),
                    studyTitle: document.getElementById('study-title'), cardCounter: document.getElementById('card-counter'),
                    flashcard: document.getElementById('flashcard'), cardFront: document.getElementById('card-front'),
                    cardBack: document.getElementById('card-back'), frontText: document.querySelector('#card-front .markdown-content'),
                    backText: document.querySelector('#card-back .markdown-content'),
                    prevButton: document.getElementById('prev-button'), nextButton: document.getElementById('next-button'),
                    backToHomeButton: document.getElementById('back-to-home-button'), editCardButton: document.getElementById('edit-card-button'),
                    deleteCardButton: document.getElementById('delete-card-button'),
                    masteryPopoverContainer: document.getElementById('mastery-popover-container'),
                    masteryPopoverButton: document.getElementById('mastery-popover-button'),
                    masteryPopover: document.getElementById('mastery-popover'),
                    masteryColorIndicator: document.getElementById('mastery-color-indicator'),
                    masteryTextIndicator: document.getElementById('mastery-text-indicator'),
                });
            },
            switchScreen(screen) {
                DOM.homeScreen.classList.toggle('hidden', screen === 'study');
                DOM.studyScreen.classList.toggle('hidden', screen === 'home');
            },
            renderFilterControls() {
                if (State.allCards.length === 0) {
                    DOM.filterControls.innerHTML = '<p class="text-sm text-slate-500">Nenhum card para filtrar.</p>';
                    return;
                }
                const specialties = [...new Set(State.allCards.map(c => c.specialty || 'Geral'))].sort();
                const tags = [...new Set(State.allCards.flatMap(c => (c.tags || '').split(',').map(t => t.trim()).filter(Boolean)))].sort();

                const createSection = (title, items, type) => {
                    if(items.length === 0) return '';
                    const itemsHtml = items.map(item => `<label class="flex items-center space-x-2 text-sm text-slate-300 hover:bg-slate-700 p-1 rounded-md cursor-pointer"><input type="checkbox" data-type="${type}" value="${item}" class="rounded text-indigo-500 focus:ring-indigo-500 bg-slate-600 border-slate-500"><span>${item}</span></label>`).join('');
                    return `<details class="mb-4" open><summary class="font-bold text-slate-300 cursor-pointer">${title}</summary><div class="mt-2 space-y-1">${itemsHtml}</div></details>`;
                };
                DOM.filterControls.innerHTML = createSection('Especialidades', specialties, 'specialties') + createSection('Tags', tags, 'tags');
            },
            renderHomeScreen() {
                DOM.folderView.innerHTML = '';
                const filters = {
                    specialties: [...DOM.filterControls.querySelectorAll('input[data-type="specialties"]:checked')].map(i => i.value),
                    tags: [...DOM.filterControls.querySelectorAll('input[data-type="tags"]:checked')].map(i => i.value),
                    search: DOM.searchInput.value.toLowerCase()
                };

                const filteredCards = State.allCards.filter(card => {
                    const specMatch = filters.specialties.length === 0 || filters.specialties.includes(card.specialty || 'Geral');
                    const cardTags = (card.tags || '').split(',').map(t => t.trim());
                    const tagMatch = filters.tags.length === 0 || filters.tags.some(t => cardTags.includes(t));
                    const searchMatch = filters.search === '' || (card.question || '').toLowerCase().includes(filters.search) || (card.answer || '').toLowerCase().includes(filters.search);
                    return specMatch && tagMatch && searchMatch;
                });
                
                const folders = filteredCards.reduce((acc, card) => {
                    const key = card.specialty || 'Geral';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(card);
                    return acc;
                }, {});

                DOM.folderViewMessage.classList.toggle('hidden', Object.keys(folders).length > 0 || State.allCards.length === 0);
                if (Object.keys(folders).length === 0 && State.allCards.length > 0) {
                     DOM.folderView.innerHTML = `<div class="col-span-full text-center p-8 text-slate-500 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">Nenhum resultado encontrado.</div>`;
                     return;
                }

                let delay = 0;
                Object.keys(folders).sort().forEach(specialty => {
                    const cardsInDeck = folders[specialty];
                    const folder = document.createElement('button');
                    folder.className = 'group bg-slate-800/70 p-4 rounded-xl shadow-lg border border-slate-700/50 text-left hover:border-indigo-500/80 hover:bg-slate-800 transition-all duration-300 transform hover:scale-[1.03]';
                    folder.style.opacity = '0';
                    folder.style.animation = `fadeIn 0.5s ease ${delay}s forwards`;
                    folder.onclick = () => startStudySession(specialty, cardsInDeck);
                    delay += 0.05;

                    const progressBar = Config.COLOR_ORDER.map(color => {
                        const count = cardsInDeck.filter(c => c.masterycolor === color).length;
                        const percentage = (count / cardsInDeck.length) * 100;
                        return percentage > 0 ? `<div style="width:${percentage}%; background-color:${Config.MASTERY_LEVELS[color].hex}"></div>` : '';
                    }).join('');

                    folder.innerHTML = `<div class="flex items-center space-x-3 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-indigo-400" viewBox="0 0 16 16"><path d="M9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31L.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3zm-8.322.12C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139z"/></svg><h3 class="text-base font-bold text-slate-200 truncate group-hover:text-white transition-colors">${specialty}</h3></div><p class="text-sm text-slate-400 ml-8">${cardsInDeck.length} Cards</p><div class="flex w-full overflow-hidden rounded-full mt-3 bg-slate-700 h-2">${progressBar}</div>`;
                    DOM.folderView.appendChild(folder);
                });
            },
            renderStudyCard() {
                 if (State.currentDeckCards.length === 0) { this.switchScreen('home'); return; }
                 if (State.currentCardIndex >= State.currentDeckCards.length) { State.currentCardIndex = 0; }
                 const card = State.currentDeckCards[State.currentCardIndex];
                 DOM.frontText.innerHTML = marked.parse(card.question || '');
                 DOM.backText.innerHTML = marked.parse(card.answer || '');
                 DOM.cardCounter.textContent = `Card ${State.currentCardIndex + 1} de ${State.currentDeckCards.length}`;
                 if (State.isFlipped) { DOM.flashcard.classList.remove('is-flipped'); State.isFlipped = false; }
                 this.updateCardAppearance();
            },
            updateCardAppearance() {
                const card = State.currentDeckCards[State.currentCardIndex];
                if (!card) return;
                const level = Config.MASTERY_LEVELS[card.masterycolor] || Config.MASTERY_LEVELS['gray'];
                
                Object.values(Config.MASTERY_LEVELS).forEach(lvl => DOM.cardFront.classList.remove(lvl.cardBg));
                DOM.cardFront.classList.add(level.cardBg);

                DOM.masteryColorIndicator.style.backgroundColor = level.hex;
                DOM.masteryTextIndicator.textContent = level.name;
            },
            renderMasteryPopover() {
                DOM.masteryPopover.innerHTML = Config.COLOR_ORDER.map(color => `<button data-color="${color}" class="mastery-btn w-full text-left py-2 px-3 rounded-md transition-colors text-white font-semibold text-sm hover:bg-slate-700 flex items-center space-x-2"><span class="w-3 h-3 rounded-full" style="background-color: ${Config.MASTERY_LEVELS[color].hex}"></span><span>${Config.MASTERY_LEVELS[color].name}</span></button>`).join('');
            },
            toggleMasteryPopover(forceState) {
                const show = forceState !== undefined ? forceState : DOM.masteryPopover.classList.contains('hidden');
                if(show) {
                    DOM.masteryPopover.classList.remove('hidden');
                    setTimeout(() => DOM.masteryPopover.classList.remove('opacity-0', 'scale-95'), 10);
                } else {
                    DOM.masteryPopover.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => DOM.masteryPopover.classList.add('hidden'), 200);
                }
            },
            showModalMessage(modalPrefix, message, isError = false) {
                const msgEl = document.getElementById(`${modalPrefix}-card-message`);
                msgEl.textContent = message;
                msgEl.classList.remove('hidden');
                msgEl.classList.toggle('text-red-500', isError);
                msgEl.classList.toggle('text-green-500', !isError);
                setTimeout(() => msgEl.classList.add('hidden'), 3000);
            },
        };

        // --- CORE LOGIC / EVENT HANDLERS ---
        function startStudySession(title, cards) {
            let deck = [...cards];
            if(DOM.shuffleToggle.checked) {
                deck.sort(() => Math.random() - 0.5);
            }
            State.currentDeckCards = deck;
            State.currentCardIndex = 0;
            State.isFlipped = false;
            DOM.studyTitle.textContent = title;
            UI.renderStudyCard();
            UI.switchScreen('study');
        }
        
        async function handleNewCardSubmit(e) {
            e.preventDefault();
            const form = DOM.newCardForm;
            const cardData = {
                question: form.querySelector('#new-card-question').value.trim(),
                answer: form.querySelector('#new-card-answer').value.trim(),
                specialty: form.querySelector('#new-card-specialty').value.trim() || 'Geral',
                tags: form.querySelector('#new-card-tags').value.trim(),
                masterycolor: 'gray'
            };
            if(!cardData.question || !cardData.answer) return;
            try {
                await FirebaseService.addCard(cardData);
                UI.showModalMessage('new', 'Card salvo!');
                form.reset();
            } catch(error) { UI.showModalMessage('new', 'Erro ao salvar.', true); }
        }

        async function handleEditCardSubmit(e) {
            e.preventDefault();
            const card = State.currentDeckCards[State.currentCardIndex];
            if(!card) return;
            const form = DOM.editCardForm;
            const cardData = {
                question: form.querySelector('#edit-card-question').value.trim(),
                answer: form.querySelector('#edit-card-answer').value.trim(),
                specialty: form.querySelector('#edit-card-specialty').value.trim() || 'Geral',
                tags: form.querySelector('#edit-card-tags').value.trim(),
            };
            try {
                await FirebaseService.updateCard(card.id, cardData);
                UI.showModalMessage('edit', 'Card atualizado!');
                setTimeout(() => DOM.editCardModal.classList.add('hidden'), 1000);
            } catch(error) { UI.showModalMessage('edit', 'Erro ao atualizar.', true); }
        }

        async function handleDeleteCard() {
            const card = State.currentDeckCards[State.currentCardIndex];
            if(!card) return;
            try {
                await FirebaseService.deleteCard(card.id);
                State.currentDeckCards.splice(State.currentCardIndex, 1);
                DOM.deleteConfirmModal.classList.add('hidden');
                UI.renderStudyCard();
            } catch(error) { console.error("Error deleting card: ", error); }
        }
        
        function setupEventListeners() {
            document.body.addEventListener('click', e => {
                const target = e.target;
                const modal = target.closest('.z-50');

                if (target.closest('#add-card-button')) DOM.newCardModal.classList.remove('hidden');
                if (target.closest('#clear-filters-button')) { DOM.searchInput.value = ''; DOM.filterControls.querySelectorAll('input').forEach(i => i.checked = false); UI.renderHomeScreen(); }
                if (target.dataset.closeModal || (modal && target === modal)) (modal || target.closest('.z-50')).classList.add('hidden');
                if (target.id === 'cancel-delete-button') DOM.deleteConfirmModal.classList.add('hidden');
                if (target.id === 'confirm-delete-button') handleDeleteCard();
                if (target.closest('#edit-card-button')) showEditModal();
                if (target.closest('#delete-card-button')) DOM.deleteConfirmModal.classList.remove('hidden');
                if (target.closest('#back-to-home-button')) UI.switchScreen('home');
                if (target.closest('#flashcard')) { State.isFlipped = !State.isFlipped; DOM.flashcard.classList.toggle('is-flipped'); }
                if (target.closest('#next-button')) { State.currentCardIndex = (State.currentCardIndex + 1) % State.currentDeckCards.length; UI.renderStudyCard(); }
                if (target.closest('#prev-button')) { State.currentCardIndex = (State.currentCardIndex - 1 + State.currentDeckCards.length) % State.currentDeckCards.length; UI.renderStudyCard(); }
                
                if (target.closest('#mastery-popover-button')) { e.stopPropagation(); UI.toggleMasteryPopover(); }
                else if (!target.closest('#mastery-popover-container')) UI.toggleMasteryPopover(false);

                const masteryBtn = target.closest('.mastery-btn');
                if(masteryBtn) {
                    const color = masteryBtn.dataset.color;
                    const card = State.currentDeckCards[State.currentCardIndex];
                    if (card) {
                        card.masterycolor = color;
                        FirebaseService.updateMastery(card.id, color);
                        UI.updateCardAppearance();
                        UI.toggleMasteryPopover(false);
                    }
                }
            });

            DOM.filterControls.addEventListener('change', UI.renderHomeScreen);
            DOM.searchInput.addEventListener('input', UI.renderHomeScreen);
            DOM.newCardForm.addEventListener('submit', handleNewCardSubmit);
            DOM.editCardForm.addEventListener('submit', handleEditCardSubmit);
        }
        
        function showEditModal() {
            const card = State.currentDeckCards[State.currentCardIndex];
            if(!card) return;
            const form = DOM.editCardForm;
            form.querySelector('#edit-card-question').value = card.question;
            form.querySelector('#edit-card-answer').value = card.answer;
            form.querySelector('#edit-card-specialty').value = card.specialty;
            form.querySelector('#edit-card-tags').value = card.tags;
            DOM.editCardModal.classList.remove('hidden');
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            UI.populate();
            UI.renderMasteryPopover();
            setupEventListeners();
            const { auth } = FirebaseService.init();
            FirebaseService.connect(auth, (cards) => {
                State.allCards = cards;
                DOM.loading.classList.add('hidden');
                UI.renderFilterControls();
                UI.renderHomeScreen();
            });
        };
    </script>
</body>
</html>

