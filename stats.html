<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas Avançadas - Flashcards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        html, body { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #111827, #1e1b4b, #312e81, #1e293b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .control-btn.active { background-color: #4f46e5; color: #ffffff; box-shadow: 0 4px 14px 0 rgb(79 70 229 / 39%);}
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .skeleton {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #2d3748 4%, #3c4a5f 25%, #2d3748 36%);
            background-size: 1000px 100%;
        }
    </style>
</head>
<body class="text-slate-200">

    <div class="w-full max-w-7xl mx-auto h-full flex flex-col p-4 md:p-6">
        <div class="w-full h-full bg-slate-900/70 backdrop-blur-xl border border-slate-700/50 rounded-3xl shadow-2xl shadow-black/30 overflow-y-auto p-6 md:p-8">
            <div class="flex justify-between items-center mb-8">
                 <h1 class="text-4xl font-extrabold text-white">Painel de Desempenho</h1>
                <a href="index.html" class="group flex items-center space-x-2 text-sm font-semibold text-slate-400 hover:text-indigo-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/></svg>
                    <span>Voltar ao App</span>
                </a>
            </div>

            <div id="loading-skeleton">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
                    <div class="h-24 bg-slate-800 rounded-xl skeleton"></div>
                    <div class="h-24 bg-slate-800 rounded-xl skeleton"></div>
                    <div class="h-24 bg-slate-800 rounded-xl skeleton"></div>
                    <div class="h-24 bg-slate-800 rounded-xl skeleton"></div>
                </div>
                <div class="h-48 bg-slate-800 rounded-xl skeleton"></div>
            </div>

            <div id="stats-container" class="hidden space-y-8">
                <div id="kpi-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5"></div>

                <div id="empty-state" class="hidden text-center py-16 px-6 bg-slate-800/80 border border-slate-700/50 rounded-2xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    <h3 class="mt-4 text-xl font-semibold text-white">Nenhum Card Encontrado</h3>
                    <p class="mt-2 text-slate-400">Parece que você ainda não criou nenhum flashcard. Comece agora para ver suas estatísticas!</p>
                    <a href="index.html" class="mt-6 inline-block bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-all">Criar seu primeiro card</a>
                </div>

                <div id="controls-and-charts" class="space-y-8">
                    <div class="p-4 bg-slate-800/80 border border-slate-700/50 rounded-xl space-y-4">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-1"><label class="text-sm font-semibold text-slate-400 mb-2 block">1. Agrupar por:</label><div id="view-mode-controls" class="flex flex-wrap gap-2">
                                <button data-mode="specialty" class="control-btn flex-1 sm:flex-none justify-center text-sm font-semibold py-2 px-4 bg-slate-700/80 rounded-lg hover:bg-slate-700">Especialidade</button>
                                <button data-mode="tags" class="control-btn flex-1 sm:flex-none justify-center text-sm font-semibold py-2 px-4 bg-slate-700/80 rounded-lg hover:bg-slate-700">Tags</button>
                            </div></div>
                            <div class="flex-1"><label class="text-sm font-semibold text-slate-400 mb-2 block">2. Formato:</label><div id="chart-type-controls" class="flex flex-wrap gap-2">
                                <button data-chart="bar" class="control-btn flex-1 sm:flex-none justify-center text-sm font-semibold py-2 px-4 bg-slate-700/80 rounded-lg hover:bg-slate-700">Barras</button>
                                <button data-chart="pie" class="control-btn flex-1 sm:flex-none justify-center text-sm font-semibold py-2 px-4 bg-slate-700/80 rounded-lg hover:bg-slate-700">Pizza</button>
                                <button data-chart="radar" class="control-btn flex-1 sm:flex-none justify-center text-sm font-semibold py-2 px-4 bg-slate-700/80 rounded-lg hover:bg-slate-700">Radar</button>
                                <button data-chart="text" class="control-btn flex-1 sm:flex-none justify-center text-sm font-semibold py-2 px-4 bg-slate-700/80 rounded-lg hover:bg-slate-700">Texto</button>
                            </div></div>
                        </div>
                        <div id="item-selector-container" class="hidden pt-4 border-t border-slate-700/50"></div>
                    </div>

                    <div>
                        <h2 id="charts-section-title" class="text-2xl font-bold text-white mb-4">Análise Detalhada</h2>
                        <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                    </div>
                     <div>
                        <h2 class="text-2xl font-bold text-white mb-4">Atividade Recente</h2>
                        <div class="bg-slate-800/80 p-4 rounded-xl border border-slate-700/50"><canvas id="activity-chart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const Config = {
            MASTERY_LEVELS: {
                'gray': { name: 'Padrão', hex: '#64748b' }, 'red': { name: 'Revisar', hex: '#ef4444' }, 'orange': { name: 'Difícil', hex: '#f97316' }, 
                'yellow': { name: 'Médio', hex: '#eab308' }, 'green': { name: 'Fácil', hex: '#22c55e' }, 'blue': { name: 'Dominado', hex: '#3b82f6' }
            },
            COLOR_ORDER: ['red', 'orange', 'yellow', 'green', 'blue', 'gray'],
            VALUE_TO_COLOR_MAP: { 0: 'gray', 1: 'red', 2: 'orange', 3: 'yellow', 4: 'green', 5: 'blue' },
            firebase: { apiKey: "AIzaSyAJ7fpCQPimWgcJuYiLbCZ5Rf5YUgMVZ2Q", authDomain: "ghus-app.firebaseapp.com", projectId: "ghus-app", storageBucket: "ghus-app.firebasestorage.app", messagingSenderId: "1047907929485", appId: "1:1047907929485:web:cba05f2850df61d201c1c4" }
        };
        const State = { allCards: [], viewMode: 'specialty', chartType: 'bar', selectedItem: 'all', activeCharts: [], activityChart: null };

        const DOM = {
            loadingSkeleton: document.getElementById('loading-skeleton'), statsContainer: document.getElementById('stats-container'),
            emptyState: document.getElementById('empty-state'), controlsAndCharts: document.getElementById('controls-and-charts'),
            kpiContainer: document.getElementById('kpi-container'), chartsContainer: document.getElementById('charts-container'),
            chartsSectionTitle: document.getElementById('charts-section-title'), viewModeControls: document.getElementById('view-mode-controls'),
            chartTypeControls: document.getElementById('chart-type-controls'), itemSelectorContainer: document.getElementById('item-selector-container'),
            activityChartCanvas: document.getElementById('activity-chart'),
        };

        const FirebaseService = {
            init() {
                const app = initializeApp(Config.firebase);
                const auth = getAuth(app);
                const db = getFirestore(app);
                return { auth, db };
            },
            async connect(auth, db, onData) {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        onSnapshot(collection(db, 'flashcards'), snapshot => {
                            const cards = snapshot.docs.map(doc => ({
                                ...doc.data(),
                                masteryColor: this.convertMastery(doc.data().masteryColor),
                                createdAt: doc.data().createdAt?.toDate()
                            }));
                            onData(cards);
                        }, err => console.error("Firebase Error:", err));
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Sign-in failed", err));
                    }
                });
            },
            convertMastery(value) {
                if (typeof value === 'string' && Config.MASTERY_LEVELS[value]) return value;
                if (typeof value === 'number' && Config.VALUE_TO_COLOR_MAP[value]) return Config.VALUE_TO_COLOR_MAP[value];
                return 'gray';
            }
        };

        const ChartManager = {
            render(canvas, title, labels, datasets, chartType) {
                if (chartType === 'radar') {
                    datasets.forEach(d => {
                        d.fill = true;
                        d.backgroundColor = d.backgroundColor.replace(')', ', 0.2)');
                        d.borderColor = d.backgroundColor.replace(', 0.2)', ')');
                        d.pointBackgroundColor = d.backgroundColor;
                    });
                }
                const scalesConfig = {
                    r: { pointLabels: { color: '#cbd5e1', font: { size: 14 } }, grid: { color: '#334155' }, angleLines: { color: '#334155' } },
                    y: { beginAtZero: true, ticks: { color: '#94a3b8', stepSize: 1 }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } }
                };
                return new Chart(canvas, {
                    type: chartType, data: { labels, datasets },
                    options: {
                        responsive: true, maintainAspectRatio: chartType !== 'bar',
                        plugins: { legend: { display: chartType !== 'bar', labels: { color: '#cbd5e1' } }, title: { display: true, text: title, color: '#e2e8f0', font: { size: 16 } } },
                        scales: chartType === 'radar' ? { r: scalesConfig.r } : (chartType === 'bar' ? { x: scalesConfig.x, y: scalesConfig.y } : {})
                    }
                });
            }
        };
        
        const UI = {
            init() {
                this.setupControls();
            },
            render(cards) {
                State.allCards = cards;
                DOM.loadingSkeleton.classList.add('hidden');
                DOM.statsContainer.classList.remove('hidden');

                if(cards.length === 0) {
                    DOM.emptyState.classList.remove('hidden');
                    DOM.controlsAndCharts.classList.add('hidden');
                    return;
                }
                DOM.emptyState.classList.add('hidden');
                DOM.controlsAndCharts.classList.remove('hidden');

                this.renderKPIs();
                this.renderActivityChart();
                this.updateView();
            },
            renderKPIs() {
                const total = State.allCards.length;
                const mastered = State.allCards.filter(c => c.masteryColor === 'blue').length;
                const needsReview = State.allCards.filter(c => c.masteryColor === 'red').length;
                const kpis = [
                    { label: 'Total de Cards', value: total, icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/><path d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8zm0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z"/></svg>` },
                    { label: 'Dominados', value: `${((mastered / total) * 100).toFixed(0)}%`, icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M3.612 15.443c-.346.197-.692.348-1.038.465a.5.5 0 0 1-.62-.492c.03-1.121.043-2.296.043-3.443a.5.5 0 0 1 .5-.5c.341 0 .682.037 1.02.108a.5.5 0 0 1 .45.592c-.044.29-.08.583-.12.88a.5.5 0 0 1-.6.44c-.26-.04-.51-.1-.75-.17a.5.5 0 0 0-.5.5c0 1.076-.01 2.152-.04 3.221.26-.06.52-.13.78-.21a.5.5 0 0 1 .593.45z"/><path d="M10.118 1.117a.5.5 0 0 1 .566.027l4.305 3.842a.5.5 0 0 1-.027.818l-4.305 3.842a.5.5 0 0 1-.839-.445V8.5H3.5a.5.5 0 0 1 0-1h6.328V6.264a.5.5 0 0 1 .273-.445z"/></svg>`},
                    { label: 'Para Revisar', value: needsReview, icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>` },
                    { label: 'Consistência', value: 'Ótima', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/></svg>` }
                ];
                DOM.kpiContainer.innerHTML = kpis.map(k => `<div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700/50 flex items-start space-x-4"><div class="text-indigo-400">${k.icon}</div><div><p class="text-sm text-slate-400">${k.label}</p><p class="text-3xl font-bold text-white">${k.value}</p></div></div>`).join('');
            },
            renderActivityChart() { /* ... */ },
            updateView() {
                this.renderItemSelector();
                this.renderMainCharts();
            },
            renderItemSelector() {
                DOM.itemSelectorContainer.classList.add('hidden');
                DOM.itemSelectorContainer.innerHTML = '';
                if (State.viewMode !== 'specialty' && State.viewMode !== 'tags') return;
                const items = [...new Set(State.allCards.flatMap(c => State.viewMode === 'tags' ? (c.tags || '').split(',').map(t => t.trim()).filter(Boolean) : (c.specialty || 'Geral')))].sort();
                if (items.length === 0) return;
                DOM.itemSelectorContainer.classList.remove('hidden');
                const labelText = State.viewMode === 'specialty' ? '3. Selecione a Especialidade:' : '3. Selecione a Tag:';
                let optionsHTML = '<option value="all">Ver Todas</option>' + items.map(item => `<option value="${item}">${item}</option>`).join('');
                DOM.itemSelectorContainer.innerHTML = `<label class="text-sm font-semibold text-slate-400 mb-2 block">${labelText}</label><select id="item-select" class="w-full p-2 bg-slate-700/80 border border-slate-600 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">${optionsHTML}</select>`;
                const select = document.getElementById('item-select');
                select.value = State.selectedItem;
                select.addEventListener('change', (e) => { State.selectedItem = e.target.value; this.renderMainCharts(); });
            },
            renderMainCharts() {
                State.activeCharts.forEach(c => c.destroy()); State.activeCharts = [];
                DOM.chartsContainer.innerHTML = '';
                const createVisual = (container, title, cards) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'chart-wrapper bg-slate-800/80 p-4 rounded-xl border border-slate-700/50 min-w-0';
                    if (State.chartType === 'text') {
                        const counts = Config.COLOR_ORDER.reduce((acc, color) => ({ ...acc, [color]: cards.filter(c => c.masteryColor === color).length }), {});
                        const total = cards.length;
                        const textContent = Config.COLOR_ORDER.map(color => `<li class="flex justify-between items-center py-1.5"><div class="flex items-center"><span class="w-3 h-3 rounded-full mr-3" style="background-color:${Config.MASTERY_LEVELS[color].hex}"></span><span>${Config.MASTERY_LEVELS[color].name}</span></div><span class="font-semibold">${counts[color]} <span class="text-slate-400 text-xs">(${(total > 0 ? (counts[color] / total) * 100 : 0).toFixed(0)}%)</span></span></li>`).join('');
                        wrapper.innerHTML = `<h3 class="text-lg font-bold text-white mb-2">${title}</h3><ul class="text-sm text-slate-300">${textContent}</ul>`;
                    } else {
                        const canvas = document.createElement('canvas');
                        wrapper.appendChild(canvas);
                        const labels = Config.COLOR_ORDER.map(c => Config.MASTERY_LEVELS[c].name);
                        const dataset = [{ label: 'Cards', data: Config.COLOR_ORDER.map(color => cards.filter(c => c.masteryColor === color).length), backgroundColor: Config.COLOR_ORDER.map(c => Config.MASTERY_LEVELS[c].hex), borderColor: '#1e293b', borderWidth: 2 }];
                        const chart = ChartManager.render(canvas, title, labels, dataset, State.chartType);
                        State.activeCharts.push(chart);
                    }
                    container.appendChild(wrapper);
                };
                if (State.viewMode === 'specialty' || State.viewMode === 'tags') {
                    const items = [...new Set(State.allCards.flatMap(c => State.viewMode === 'tags' ? (c.tags || '').split(',').map(t => t.trim()).filter(Boolean) : (c.specialty || 'Geral')))].sort();
                    const itemsToRender = State.selectedItem === 'all' ? items : [State.selectedItem];
                    itemsToRender.forEach(item => {
                        const cards = State.allCards.filter(c => State.viewMode === 'tags' ? (c.tags || '').includes(item) : (c.specialty || 'Geral') === item);
                        if (cards.length > 0) createVisual(DOM.chartsContainer, `${item} (${cards.length})`, cards);
                    });
                }
            },
            setupControls() {
                DOM.viewModeControls.addEventListener('click', e => {
                    if (e.target.tagName !== 'BUTTON') return;
                    State.viewMode = e.target.dataset.mode;
                    State.selectedItem = 'all';
                    this.updateActiveButton(DOM.viewModeControls, State.viewMode, 'mode');
                    this.updateView();
                });
                DOM.chartTypeControls.addEventListener('click', e => {
                    if (e.target.tagName !== 'BUTTON') return;
                    State.chartType = e.target.dataset.chart;
                    this.updateActiveButton(DOM.chartTypeControls, State.chartType, 'chart');
                    this.renderMainCharts();
                });
                this.updateActiveButton(DOM.viewModeControls, State.viewMode, 'mode');
                this.updateActiveButton(DOM.chartTypeControls, State.chartType, 'chart');
            },
            updateActiveButton(container, value, dataAttr) {
                container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                const activeBtn = container.querySelector(`button[data-${dataAttr}="${value}"]`);
                if (activeBtn) activeBtn.classList.add('active');
            }
        };

        window.onload = async () => {
            const { auth, db } = FirebaseService.init();
            UI.init();
            await FirebaseService.connect(auth, db, (cards) => {
                UI.render(cards);
            });
        };
    </script>
</body>
</html>

